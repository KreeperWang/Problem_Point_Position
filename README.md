train_blip.py--only use blip2-2.7b model
train_blip_enhanced.py --use enhanced frame 
utils.py -- for enhanced frame
config.py -- for both 2 method


# PGDP5K å‡ ä½•å›¾å½¢ç‚¹ä½ç½®è¯†åˆ«æ•°æ®é›†

![Dataset Banner](https://img.shields.io/badge/Dataset-PGDP5K-blue) ![Task](https://img.shields.io/badge/Task-Point%20Position%20Detection-green) ![Language](https://img.shields.io/badge/Language-Python-orange)

## ğŸ“– æ•°æ®é›†ç®€ä»‹

**PGDP5K (Plane Geometry Diagram Parsing 5K)** æ˜¯ä¸€ä¸ªå‡ ä½•å›¾å½¢å½¢å¼åŒ–æ•°æ®é›†ã€‚è¯¥æ•°æ®é›†åŒ…å«5000å¼ å‡ ä½•ç¤ºæ„å›¾ï¼Œæ¯å¼ å›¾éƒ½æ ‡æ³¨äº†å›¾ä¸­å…³é”®ç‚¹çš„ç²¾ç¡®åæ ‡ä½ç½®ã€‚

### ğŸ¯ ä»»åŠ¡ç›®æ ‡
- **ä¸»è¦ä»»åŠ¡**: ä»å‡ ä½•ç¤ºæ„å›¾ä¸­å‡†ç¡®è¯†åˆ«å¹¶è¾“å‡ºæŒ‡å®šç‚¹çš„åæ ‡ä½ç½®
- **åº”ç”¨åœºæ™¯**: å‡ ä½•æ•™å­¦è¾…åŠ©ã€è‡ªåŠ¨æ‰¹æ”¹ç³»ç»Ÿã€å‡ ä½•å›¾å½¢åˆ†æ
- **æŠ€æœ¯æŒ‘æˆ˜**: å¤šæ¨¡æ€ç†è§£ã€ç²¾ç¡®å®šä½ã€ç‚¹åæ˜ å°„

## ğŸ“Š æ•°æ®é›†ç»Ÿè®¡

| é¡¹ç›® | æ•°å€¼ |
|------|------|
| **æ€»å›¾åƒæ•°é‡** | 5,000å¼  |
| **è®­ç»ƒé›†** | 4,000å¼  |
| **æµ‹è¯•é›†** | 1,000å¼  |
| **å›¾åƒæ ¼å¼** | PNG |
| **æ ‡æ³¨æ ¼å¼** | JSON |
| **ç‚¹åæ ‡ç²¾åº¦** | åƒç´ çº§ |

## ğŸ“ æ–‡ä»¶ç»“æ„

```
Problem_Point_Position/
â”œâ”€â”€ README.md              # æœ¬æ–‡æ¡£
â”œâ”€â”€ train.json            # è®­ç»ƒé›†æ ‡æ³¨æ–‡ä»¶ (4,000æ¡)
â”œâ”€â”€ test.json             # æµ‹è¯•é›†æ ‡æ³¨æ–‡ä»¶ (1,000æ¡)
â”œâ”€â”€ cal_acc.py            # è¯„ä¼°è„šæœ¬
â””â”€â”€ Images/               # å›¾åƒæ–‡ä»¶å¤¹
    â”œâ”€â”€ 0.png
    â”œâ”€â”€ 1.png
    â”œâ”€â”€ ...
    â””â”€â”€ 4999.png
```

## ğŸ“‹ æ•°æ®æ ¼å¼è¯´æ˜

### å›¾åƒæ–‡ä»¶
- **å‘½åè§„åˆ™**: `{ID}.png`ï¼Œå…¶ä¸­IDä¸º0-4999çš„æ•´æ•°
- **å›¾åƒå†…å®¹**: åŒ…å«å„ç§å‡ ä½•å›¾å½¢çš„ç¤ºæ„å›¾ï¼Œå¦‚ä¸‰è§’å½¢ã€å››è¾¹å½¢ã€åœ†å½¢ç­‰
- **å›¾åƒè´¨é‡**: æ¸…æ™°çš„å‡ ä½•å›¾å½¢ï¼Œç‚¹æ ‡è®°æ˜æ˜¾

### æ ‡æ³¨æ–‡ä»¶æ ¼å¼

JSONæ–‡ä»¶é‡‡ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

```json
{
  "å›¾åƒID": {
    "ç‚¹å": [xåæ ‡, yåæ ‡],
    "ç‚¹å": [xåæ ‡, yåæ ‡],
    ...
  }
}
```

#### ç¤ºä¾‹
```json
{
  "4238": {
    "Y": [711.36, 85.40397350993378],
    "R": [126.72, 183.12582781456953],
    "S": [180.0, 344.9006622516556],
    "X": [764.0228571428571, 247.17880794701986],
    "T": [446.4, 127.28476821192052],
    "Z": [443.88, 302.1473509933775]
  }
}
```

### æ•°æ®ç‰¹ç‚¹
- **åæ ‡ç³»**: å›¾åƒåæ ‡ç³»ï¼ŒåŸç‚¹(0,0)ä½äºå›¾åƒå·¦ä¸Šè§’
- **ç‚¹å‘½å**: ä½¿ç”¨å¤§å†™è‹±æ–‡å­—æ¯(A-Z)å‘½åå‡ ä½•å›¾å½¢ä¸­çš„å…³é”®ç‚¹
- **åæ ‡ç²¾åº¦**: æ”¯æŒæµ®ç‚¹æ•°åæ ‡ï¼Œç²¾ç¡®åˆ°å°æ•°ç‚¹åå¤šä½
- **ç‚¹æ•°é‡**: æ¯å¼ å›¾åƒåŒ…å«2-10ä¸ªä¸ç­‰çš„æ ‡æ³¨ç‚¹

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
```bash
Python >= 3.7
numpy
matplotlib
json
```

### æ•°æ®åŠ è½½ç¤ºä¾‹

```python
import json
import os

# åŠ è½½è®­ç»ƒæ•°æ®
def load_dataset(annotation_file, image_dir):
    with open(annotation_file, 'r', encoding='utf-8') as f:
        annotations = json.load(f)
    
    dataset = []
    for image_id, points in annotations.items():
        image_path = os.path.join(image_dir, f"{image_id}.png")
        if os.path.exists(image_path):
            dataset.append({
                'image_id': image_id,
                'image_path': image_path,
                'points': points
            })
    
    return dataset

# ä½¿ç”¨ç¤ºä¾‹
train_data = load_dataset('train.json', 'Images/')
test_data = load_dataset('test.json', 'Images/')

print(f"è®­ç»ƒé›†æ ·æœ¬æ•°: {len(train_data)}")
print(f"æµ‹è¯•é›†æ ·æœ¬æ•°: {len(test_data)}")
```

## ğŸ“ è¯„ä¼°æ–¹æ³•

æˆ‘ä»¬æä¾›äº†å®Œæ•´çš„è¯„ä¼°è„šæœ¬ `cal_acc.py`ï¼Œæ”¯æŒå¤šç§è¯„ä¼°æŒ‡æ ‡ï¼š

### æ ¸å¿ƒè¯„ä¼°æŒ‡æ ‡

1. **æ¬§å‡ é‡Œå¾—è·ç¦»è¯¯å·® (Euclidean Distance Error)**
   - è®¡ç®—é¢„æµ‹ç‚¹ä¸çœŸå®ç‚¹ä¹‹é—´çš„åƒç´ è·ç¦»
   - å…¬å¼: `distance = âˆš[(xâ‚-xâ‚‚)Â² + (yâ‚-yâ‚‚)Â²]`

2. **å¹³å‡ç»å¯¹è¯¯å·® (MAE)**
   - æ‰€æœ‰åŒ¹é…ç‚¹çš„å¹³å‡è·ç¦»è¯¯å·®
   - åæ˜ æ¨¡å‹æ•´ä½“å®šä½ç²¾åº¦

3. **é˜ˆå€¼å‡†ç¡®ç‡ (Accuracy@Threshold)**
   - åœ¨ä¸åŒåƒç´ é˜ˆå€¼ä¸‹çš„å‡†ç¡®ç‡
   - é»˜è®¤é˜ˆå€¼: 5px, 10px, 15px, 20px

4. **ç‚¹æ£€æµ‹ç‡æ›²çº¿ (PDR Curve)**
   - Point Detection Rate vs Distance Threshold
   - å¯è§†åŒ–æ¨¡å‹åœ¨ä¸åŒç²¾åº¦è¦æ±‚ä¸‹çš„æ€§èƒ½

5. **å½’ä¸€åŒ–æ¬§å‡ é‡Œå¾—è·ç¦»è¯¯å·® (Normalized Euclidean Distance Error)**
   - è®¡ç®—é¢„æµ‹ç‚¹ä¸çœŸå®ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œå¹¶é™¤ä»¥å›¾åƒå¯¹è§’çº¿é•¿åº¦ï¼Œå®ç°å°ºåº¦æ— å…³çš„è¯¯å·®è¯„ä¼°
   - å…¬å¼: `normalized_distance = distance / diag_len`ï¼Œå…¶ä¸­`diag_len = sqrt(width^2 + height^2)`
   - è¾“å‡ºä¸ºæ‰€æœ‰ç‚¹çš„å¹³å‡å½’ä¸€åŒ–è·ç¦»è¯¯å·®ï¼ŒèŒƒå›´0~1ï¼Œè¶Šå°è¶Šå¥½

6. **ç›¸å¯¹ç‚¹é—´è·ç¦»è¯¯å·® (Relative Point Distance Error)**
   - è®¡ç®—æ‰€æœ‰ç‚¹å¯¹ä¹‹é—´çš„é¢„æµ‹è·ç¦»ä¸çœŸå®è·ç¦»çš„å¹³å‡è¯¯å·®ï¼Œåæ˜ æ¨¡å‹å¯¹ç‚¹é—´ç›¸å¯¹å…³ç³»çš„æŠŠæ¡
   - å…¬å¼: `mean(|d_pred(i,j) - d_gt(i,j)|)`ï¼Œå…¶ä¸­`d_pred(i,j)`ä¸ºé¢„æµ‹ç‚¹iå’Œjçš„è·ç¦»ï¼Œ`d_gt(i,j)`ä¸ºçœŸå®è·ç¦»
   - è¾“å‡ºä¸ºæ‰€æœ‰å›¾åƒçš„å¹³å‡ç›¸å¯¹ç‚¹é—´è·ç¦»è¯¯å·®ï¼Œå•ä½ä¸ºåƒç´ ï¼Œè¶Šå°è¶Šå¥½

### ä½¿ç”¨è¯„ä¼°è„šæœ¬

```python
from cal_acc import PointAccuracyCalculator

# åˆ›å»ºè¯„ä¼°å™¨
calculator = PointAccuracyCalculator(
    gt_file='test.json',           # çœŸå®æ ‡æ³¨
    pred_file='predictions.json',  # æ¨¡å‹é¢„æµ‹ç»“æœ
    image_size=(800, 600)         # å›¾åƒå°ºå¯¸(å¯é€‰)
)

# è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
results = calculator.calculate_all_metrics(
    thresholds=[5, 10, 15, 20, 25]
)

# æ‰“å°ç»“æœ
calculator.print_results()

# ç»˜åˆ¶PDRæ›²çº¿
calculator.plot_pdr_curve()

# ä¿å­˜ç»“æœ
calculator.save_results('evaluation_results.json')

# è·å–å½’ä¸€åŒ–è¯¯å·®å’Œç›¸å¯¹ç‚¹é—´è·ç¦»è¯¯å·®
print('å½’ä¸€åŒ–å¹³å‡è·ç¦»è¯¯å·®:', results.get('mean_normalized_error'))
print('ç›¸å¯¹ç‚¹é—´è·ç¦»è¯¯å·®:', results.get('relative_point_distance_error'))
```

### é¢„æµ‹ç»“æœæ ¼å¼è¦æ±‚

æ¨¡å‹çš„é¢„æµ‹ç»“æœéœ€è¦ä¿å­˜ä¸ºä¸æ ‡æ³¨æ–‡ä»¶ç›¸åŒæ ¼å¼çš„JSONæ–‡ä»¶ï¼š

```json
{
  "å›¾åƒID": {
    "ç‚¹å": [é¢„æµ‹xåæ ‡, é¢„æµ‹yåæ ‡],
    "ç‚¹å": [é¢„æµ‹xåæ ‡, é¢„æµ‹yåæ ‡]
  }
}
```

## ğŸ† åŸºå‡†æ€§èƒ½

### è¯„ä¼°åŸºå‡†
- **ä¼˜ç§€**: MAE < 5px, Accuracy@10px > 90%
- **è‰¯å¥½**: MAE < 10px, Accuracy@15px > 85%
- **åŠæ ¼**: MAE < 20px, Accuracy@20px > 70%

### è¯„ä¼°æ³¨æ„äº‹é¡¹
1. **ç‚¹ååŒ¹é…**: é¢„æµ‹ç»“æœä¸­çš„ç‚¹åå¿…é¡»ä¸æ ‡æ³¨æ–‡ä»¶ä¸­çš„ç‚¹åå®Œå…¨ä¸€è‡´
2. **ç¼ºå¤±å¤„ç†**: å¦‚æœæ¨¡å‹æœªé¢„æµ‹æŸä¸ªç‚¹ï¼Œè¯¥ç‚¹å°†è¢«è®¡ä¸ºæœ€å¤§è¯¯å·®
3. **é¢å¤–ç‚¹**: é¢„æµ‹æ–‡ä»¶ä¸­çš„é¢å¤–ç‚¹ï¼ˆæ ‡æ³¨ä¸­ä¸å­˜åœ¨ï¼‰å°†è¢«å¿½ç•¥
4. **åæ ‡èŒƒå›´**: åæ ‡åº”åœ¨åˆç†çš„å›¾åƒèŒƒå›´å†…

### ğŸ“ è‡´è¥å‘˜çš„è¯

è¿™ä¸ªæ•°æ®é›†æ˜¯ä¸“é—¨ä¸ºæ‚¨çš„å¤šæ¨¡æ€å¤§æ¨¡å‹å¾®è°ƒå®è·µè€Œå‡†å¤‡çš„ã€‚é€šè¿‡è¿™ä¸ªä»»åŠ¡ï¼Œæ‚¨å°†å­¦ä¼šï¼š

1. **å¤šæ¨¡æ€ç†è§£**: å¦‚ä½•è®©AIåŒæ—¶ç†è§£å›¾åƒå’Œæ–‡æœ¬ä¿¡æ¯
2. **ç²¾ç¡®å®šä½**: å¦‚ä½•è®­ç»ƒæ¨¡å‹è¿›è¡Œåƒç´ çº§çš„ç²¾ç¡®å®šä½
3. **å‡ ä½•æ¨ç†**: å¦‚ä½•è®©AIç†è§£å‡ ä½•å›¾å½¢çš„ç©ºé—´å…³ç³»
4. **è¯„ä¼°æ–¹æ³•**: å¦‚ä½•è®¾è®¡åˆç†çš„è¯„ä¼°æŒ‡æ ‡æ¥è¡¡é‡æ¨¡å‹æ€§èƒ½

å»ºè®®æ‚¨ä»ç®€å•çš„å‡ ä½•å›¾å½¢å¼€å§‹ï¼Œé€æ­¥æå‡æ¨¡å‹çš„å¤æ‚åº¦ã€‚è®°ä½ï¼Œå¥½çš„ç»“æœéœ€è¦è€å¿ƒçš„è°ƒè¯•å’Œä¼˜åŒ–ï¼

**ç¥æ‚¨å­¦ä¹ é¡ºåˆ©ï¼ğŸš€**
